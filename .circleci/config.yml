# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

orbs:
  buildkit: springload/buildkit@0.0.6
jobs:
  build_test_and_push_image:
    executor: buildkit/default
    steps:
      - buildkit/builder:
          builds:
            - buildkit/build:
                target: app
                tag: app
                path: docker/application
            - buildkit/build:
                target: app-test
                tag: app-test
                path: docker/application
            - buildkit/build:
                target: tasks
                tag: tasks
                path: docker/application
            - buildkit/build:
                tag: httpd
                context: docker/httpd
                path: docker/httpd
          after-builds:
            - run:
                name: run tests
                command: |-
                  docker run --name=database --expose 5432 \
                      -ePOSTGRES_DB=${PROJECT}_test \
                      -d postgres:10-alpine
                  docker run --name=cache --expose 6379 -d redis:4-alpine
                  docker run \
                      -i --name app-test --rm \
                      --link=database --link=cache \
                      -eDATABASE_URL="postgres://postgres@database/${PROJECT}_test" \
                      -eENVIRONMENT=test \
                      -eDJANGO_SETTINGS_MODULE=app.settings.base \
                      -eCACHE_URL=redis://cache:6379/0 \
                      -eTASK_QUEUE_URL=redis://cache:6379/1 \
                      app-test

                      # Define a job to be invoked later in a workflow.
  say-hello:
    # Specify the execution environment. You can specify an image from Dockerhub or use one of our Convenience Images from CircleCI's Developer Hub.
    # See: https://circleci.com/docs/2.0/configuration-reference/#docker-machine-macos-windows-executor
    docker:
      - image: cimg/base:stable
    # Add steps to the job
    # See: https://circleci.com/docs/2.0/configuration-reference/#steps
    steps:
      - checkout
      - run:
          name: "Say hello"
          command: "echo Hello, World!"

# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  compile-workflow:
      jobs:
        - build_test_and_push_image            
  say-hello-workflow:
    jobs:
      - say-hello
